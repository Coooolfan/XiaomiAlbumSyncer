# 任务列表：灵活的同步与归档模式配置

## 概述

本任务列表描述了实现灵活的同步与归档模式配置功能的具体步骤。该功能是对 spec 2（云端同步与智能归档功能）的扩展，主要包括：

1. 新增同步模式选项（仅新增 / 同步所有变化）
2. 扩展归档模式选项（新增"关闭归档"）
3. 配置验证和迁移
4. 前端界面更新

## 任务

- [x] 1. 扩展数据模型和枚举类型
  - [x] 1.1 创建 SyncMode 枚举类
    - 定义 ADD_ONLY 和 SYNC_ALL_CHANGES 两个枚举值
    - 添加中文注释说明每个模式的含义
    - _需求：1.2, 1.3_
  
  - [x] 1.2 扩展 ArchiveMode 枚举类
    - 在现有的 TIME 和 SPACE 基础上添加 DISABLED 枚举值
    - 添加中文注释说明
    - _需求：2.2_
  
  - [x] 1.3 扩展 CrontabConfig 数据类
    - 添加 syncMode 字段，默认值为 SyncMode.ADD_ONLY
    - 确保 archiveMode 字段支持 DISABLED 选项
    - 添加字段注释
    - _需求：1.1, 2.1, 6.1, 6.2_

- [x] 2. 实现配置验证逻辑
  - [x] 2.1 创建 ConfigValidator 类
    - 实现 validateSyncMode 方法
    - 实现 validateArchiveMode 方法
    - 实现 validateConfigConsistency 方法
    - _需求：9.1, 9.2, 9.3_
  
  - [ ] 2.2 编写配置验证单元测试
    - 测试保留天数验证（正整数）
    - 测试空间阈值验证（1-100）
    - 测试无效值被拒绝
    - _需求：9.1, 9.2, 9.3_

- [x] 3. 增强 SyncService 实现
  - [x] 3.1 修改 executeSync 方法
    - 在同步逻辑中添加 syncMode 判断
    - ADD_ONLY 模式：只处理新增操作
    - SYNC_ALL_CHANGES 模式：处理新增、删除、修改操作
    - 添加日志记录不同模式的行为
    - _需求：1.4, 1.5, 10.1, 10.2, 10.3, 10.4_
  
  - [ ]* 3.2 编写同步模式单元测试
    - 测试 ADD_ONLY 模式只处理新增
    - 测试 SYNC_ALL_CHANGES 模式处理所有变化
    - _需求：1.4, 1.5_
  
  - [ ]* 3.3 编写同步模式属性测试
    - **属性 1：ADD_ONLY 模式仅处理新增**
    - **验证：需求 1.4, 10.1, 10.2**
    - **属性 2：SYNC_ALL_CHANGES 模式同步所有变化**
    - **验证：需求 1.5, 10.3, 10.4**

- [x] 4. 增强 ArchiveService 实现
  - [x] 4.1 修改 previewArchive 方法
    - 添加 archiveMode 判断
    - DISABLED 模式：返回空计划
    - 其他模式：按原有逻辑执行
    - _需求：2.5_
  
  - [x] 4.2 修改 executeArchive 方法
    - 添加 archiveMode 判断
    - DISABLED 模式：抛出 ArchiveDisabledException
    - 其他模式：按原有逻辑执行
    - _需求：2.5_
  
  - [ ]* 4.3 编写归档模式单元测试
    - 测试 DISABLED 模式不执行归档
    - 测试 TIME 模式按时间归档
    - 测试 SPACE 模式按空间归档
    - _需求：2.5, 3.3, 4.3_
  
  - [ ]* 4.4 编写归档模式属性测试
    - **属性 3：DISABLED 模式不执行归档**
    - **验证：需求 2.5**
    - **属性 4：TIME 模式按时间归档**
    - **验证：需求 3.3**
    - **属性 5：SPACE 模式按空间阈值归档**
    - **验证：需求 4.3**

- [ ] 5. 实现配置迁移服务
  - [x] 5.1 创建 ConfigMigrationService 类
    - 实现 migrateConfigs 方法
    - 为旧配置设置默认 syncMode = ADD_ONLY
    - 根据 enableArchive 设置 archiveMode
    - 使用 @PostConstruct 在应用启动时执行
    - _需求：7.1, 7.2, 7.3, 7.4_
  
  - [ ]* 5.2 编写配置迁移单元测试
    - 测试默认 syncMode 设置
    - 测试 enableArchive = false 时设置 DISABLED
    - 测试 enableArchive = true 时保留原有模式
    - _需求：7.1, 7.3, 7.4_
  
  - [ ]* 5.3 编写配置迁移属性测试
    - **属性 11：配置迁移默认值正确性**
    - **验证：需求 7.1**
    - **属性 12：归档模式迁移正确性**
    - **验证：需求 7.3, 7.4**

- [x] 6. 检查点 - 后端功能验证
  - [x] 确保所有后端测试通过
  - [x] 验证配置迁移逻辑正确
  - [x] 验证同步和归档服务增强正确
  - [x] 修复 Jimmer ORM UnloadedException 问题
  - [x] 修复同步记录保存问题
  - [x] 修复孤儿文件清理问题
  - [x] **修复同步时不会自动归档的问题**
    - [x] 修改后端逻辑，主要依赖 archiveMode 而不是 enableArchive
    - [x] 修改前端逻辑，保存时自动同步 enableArchive 和 archiveMode
    - [x] **修复 ArchiveService 中的 Jimmer UnloadedException 问题**
    - [x] **修复 ArchiveRecord 保存时的 SaveException 问题**

- [ ] 7. 更新前端 API 类型定义
  - [x] 7.1 运行 API 生成脚本
    - 生成包含 SyncMode 和扩展 ArchiveMode 的类型定义
    - 验证生成的类型定义正确
    - _需求：1.1, 2.1_

- [ ] 8. 创建前端配置组件
  - [x] 8.1 创建或更新同步模式选择器组件
    - 添加单选按钮组或下拉选择器
    - 显示"仅新增"和"同步所有变化"选项
    - 为每个选项添加简短描述
    - 默认选择 ADD_ONLY
    - _需求：1.1, 8.1_
  
  - [x] 8.2 更新归档模式选择器组件
    - 添加"关闭归档"选项
    - 保留"根据时间归档"和"根据空间归档"选项
    - 为每个选项添加简短描述
    - _需求：2.1, 8.2_
  
  - [x] 8.3 实现条件显示逻辑
    - 当选择 TIME 模式时，显示"保留天数"输入框
    - 当选择 SPACE 模式时，显示"空间阈值"输入框
    - 当选择 DISABLED 模式时，隐藏所有归档配置项
    - _需求：3.1, 3.4, 4.1, 4.4, 8.3_
  
  - [x] 8.4 实现前端配置验证
    - 验证保留天数为正整数
    - 验证空间阈值在 1-100 之间
    - 显示清晰的错误提示
    - 阻止提交无效配置
    - _需求：9.1, 9.2, 9.3, 8.4_

- [ ] 9. 集成到现有配置页面
  - [x] 9.1 更新 Crontab 配置页面
    - 在同步配置区域添加同步模式选择器
    - 在归档配置区域更新归档模式选择器
    - 确保布局清晰美观
    - _需求：1.1, 2.1_
  
  - [x] 9.2 更新配置保存逻辑
    - 确保 syncMode 和 archiveMode 正确保存
    - 自动同步 enableArchive 和 archiveMode
    - _需求：6.1, 6.2, 6.3_
  
  - [x] 9.3 更新配置加载逻辑
    - 正确加载和显示 syncMode
    - 正确加载和显示 archiveMode
    - 根据模式显示或隐藏相关配置项
    - _需求：6.4_

- [ ] 10. 前端测试
  - [ ]* 10.1 编写组件单元测试
    - 测试同步模式选择器显示正确
    - 测试归档模式选择器显示正确
    - 测试条件显示逻辑
    - 测试配置验证
  
  - [ ]* 10.2 手动测试前端交互
    - 测试切换同步模式
    - 测试切换归档模式
    - 测试条件显示/隐藏
    - 测试配置保存和加载

- [ ] 11. 集成测试
  - [ ]* 11.1 测试完整的配置流程
    - 创建新 Crontab 并配置同步模式
    - 创建新 Crontab 并配置归档模式
    - 保存并重新加载配置
    - 验证配置正确保存和加载
    - _需求：6.1, 6.2, 6.3, 6.4_
  
  - [ ]* 11.2 测试同步功能（不同模式）
    - 测试 ADD_ONLY 模式的同步行为
    - 测试 SYNC_ALL_CHANGES 模式的同步行为
    - 验证云端变化的处理正确
    - _需求：1.4, 1.5, 10.1, 10.2, 10.3, 10.4_
  
  - [ ]* 11.3 测试归档功能（不同模式）
    - 测试 DISABLED 模式不执行归档
    - 测试 TIME 模式按时间归档
    - 测试 SPACE 模式按空间归档
    - _需求：2.5, 3.3, 4.3_
  
  - [ ]* 11.4 测试配置迁移
    - 准备旧版本的配置数据
    - 启动应用触发迁移
    - 验证迁移后的配置正确
    - _需求：7.1, 7.2, 7.3, 7.4_
  
  - [ ]* 11.5 测试配置约束遵循
    - **属性 6：同步操作遵循 Crontab 配置**
    - **验证：需求 5.1, 5.2, 5.3**
    - **属性 7：归档操作遵循 Crontab 配置**
    - **验证：需求 5.4, 5.5, 5.6**
  
  - [ ]* 11.6 测试配置持久化
    - **属性 8：配置往返一致性**
    - **验证：需求 6.1, 6.2, 6.3**

- [ ] 12. 检查点 - 完整功能验证
  - 确保所有测试通过
  - 验证前后端集成正确
  - 验证用户体验流畅
  - 如有问题，请向用户询问

- [ ] 13. 文档更新
  - [ ] 13.1 更新用户文档
    - 添加同步模式说明
    - 添加归档模式说明
    - 添加配置示例
  
  - [ ] 13.2 更新开发文档
    - 记录新增的枚举类型
    - 记录配置迁移逻辑
    - 记录 API 变化

- [ ] 14. 部署准备
  - [ ] 14.1 准备数据库备份脚本
    - 编写备份脚本
    - 测试备份和恢复流程
  
  - [ ] 14.2 准备部署文档
    - 编写升级步骤
    - 编写回滚步骤
    - 编写验证清单
  
  - [ ] 14.3 准备发布说明
    - 编写新功能说明
    - 编写升级注意事项
    - 编写已知问题（如有）

---

## 任务优先级说明

- 无标记：必须实现（P0）
- `*`：可选实现（P2），主要是测试相关任务

## 预估工作量

- 任务 1-2：1 天（数据模型和验证）
- 任务 3-4：2-3 天（服务层增强）
- 任务 5：1 天（配置迁移）
- 任务 6：检查点
- 任务 7-9：2-3 天（前端实现）
- 任务 10：1 天（前端测试）
- 任务 11：2 天（集成测试）
- 任务 12：检查点
- 任务 13-14：1 天（文档和部署）

**总计：约 10-13 天**

## 依赖关系

- 任务 3 依赖任务 1（数据模型）
- 任务 4 依赖任务 1（数据模型）
- 任务 5 依赖任务 1（数据模型）
- 任务 7 依赖任务 1-5（后端完成）
- 任务 8-9 依赖任务 7（API 类型定义）
- 任务 10 依赖任务 8-9（前端组件）
- 任务 11 依赖任务 1-10（所有功能完成）
- 任务 13-14 依赖任务 11（测试通过）

## 注意事项

1. **向后兼容性**：所有修改必须保持与现有功能的兼容性
2. **配置迁移**：确保配置迁移逻辑正确且幂等
3. **用户体验**：前端界面应清晰易懂，避免用户困惑
4. **测试覆盖**：虽然测试任务标记为可选，但强烈建议完成以确保质量
5. **数据安全**：升级前务必备份数据库
