# 实现计划：同步功能增强

## 概述

本实现计划将同步功能增强特性集成到现有的 `SyncService` 中。我们将按照以下顺序实现：

1. 文件类型过滤
2. 跳过已存在文件
3. 自定义文件路径表达式
4. 并发处理优化
5. 时间线差异对比优化
6. 集成测试和验证

每个任务都会引用具体的需求，确保可追溯性。

## 任务

- [x] 1. 增强 SyncService 的文件类型过滤功能
  - 在 `detectSyncChanges` 方法中应用文件类型过滤
  - 过滤逻辑应用于 ADD、UPDATE、DELETE 操作
  - 记录被过滤的资产数量
  - _需求：1.1, 1.2, 1.3, 1.7, 1.8, 1.9_

- [ ]* 1.1 为文件类型过滤编写属性测试
  - **属性 1：文件类型过滤完整性**
  - **验证需求：1.1, 1.2, 1.3, 1.4, 1.5, 1.6**

- [ ]* 1.2 为文件类型过滤编写属性测试
  - **属性 2：文件类型过滤应用于所有操作**
  - **验证需求：1.7, 1.8, 1.9**

- [x] 2. 在 FileService 中添加文件检查方法
  - 实现 `fileExists(path: Path): Boolean` 方法
  - 实现 `getFileSize(path: Path): Long` 方法
  - 添加错误处理（文件访问权限问题）
  - _需求：2.1, 2.2_

- [ ] 3. 在 SyncService 中实现跳过已存在文件功能
  - [x] 3.1 在 ADD 操作中添加文件存在检查
    - 检查 `skipExistingFile` 配置
    - 调用 `FileService.fileExists` 和 `getFileSize`
    - 比较文件大小与资产大小
    - 如果匹配则跳过下载，记录同步详情
    - _需求：2.1, 2.3, 2.7_

  - [x] 3.2 在 UPDATE 操作中添加文件存在检查
    - 与 ADD 操作类似的逻辑
    - _需求：2.2, 2.3, 2.7_

  - [ ]* 3.3 为跳过已存在文件编写属性测试
    - **属性 3：跳过已存在文件的逻辑完整性**
    - **验证需求：2.3, 2.4, 2.5, 2.6**

  - [ ]* 3.4 为跳过下载记录编写属性测试
    - **属性 4：跳过下载时记录同步详情**
    - **验证需求：2.7**

- [ ] 4. 实现自定义文件路径表达式功能
  - [x] 4.1 在 SyncService 中添加 `generateFilePath` 方法
    - 检查 `expressionTargetPath` 配置
    - 如果不为空，使用表达式生成路径
    - 如果为空或解析失败，使用默认路径
    - 复用 `CrontabHistoryDetail.genFilePath` 的逻辑
    - _需求：3.1, 3.2, 3.6_

  - [x] 4.2 实现变量替换逻辑
    - 支持基本变量（album, fileName, assetId 等）
    - 支持时间格式化变量（download_YYYYMM, taken_YYYY-MM-DD 等）
    - 使用 `sanitizeSegment` 清理路径片段
    - 保留不支持的变量标记
    - 使用 `Path.normalize()` 规范化路径
    - _需求：3.3, 3.4, 3.5, 3.7, 3.8_

  - [x] 4.3 在 ADD 和 UPDATE 操作中使用 `generateFilePath`
    - 替换硬编码的路径生成逻辑
    - _需求：3.1, 3.2_

  - [ ]* 4.4 为路径表达式选择编写属性测试
    - **属性 5：路径表达式选择逻辑**
    - **验证需求：3.1, 3.2, 3.6**

  - [ ]* 4.5 为变量替换编写属性测试
    - **属性 6：路径表达式变量替换完整性**
    - **验证需求：3.3, 3.4**

  - [ ]* 4.6 为路径片段清理编写属性测试
    - **属性 7：路径片段清理**
    - **验证需求：3.5**

  - [ ]* 4.7 为不支持变量保留编写属性测试
    - **属性 8：不支持变量的保留**
    - **验证需求：3.7**

  - [ ]* 4.8 为路径规范化编写属性测试
    - **属性 9：路径规范化**
    - **验证需求：3.8**

- [ ] 5. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

- [ ] 6. 实现并发处理优化
  - [x] 6.1 重构 ADD 操作使用 Flow 并发处理
    - 将 `changes.addedAssets` 转换为 Flow
    - 使用 `flatMapMerge(crontab.config.downloaders)` 实现并发
    - 每个资产在独立的 flow 中处理
    - 使用 try-catch 实现错误隔离
    - _需求：4.1, 4.2, 4.3, 4.5_

  - [x] 6.2 重构 UPDATE 操作使用 Flow 并发处理
    - 与 ADD 操作类似的并发逻辑
    - _需求：4.1, 4.2, 4.4, 4.5_

  - [x] 6.3 确保同步记录在所有任务完成后更新
    - 使用 Flow 的 `collect()` 等待所有任务完成
    - 然后调用 `updateSyncRecord`
    - _需求：4.8_

  - [ ]* 6.4 为错误隔离编写属性测试
    - **属性 10：错误隔离和记录**
    - **验证需求：4.5, 4.6**

  - [ ]* 6.5 为同步记录更新时机编写属性测试
    - **属性 11：同步记录更新时机**
    - **验证需求：4.8**

- [ ] 7. 集成时间线差异对比功能
  - [x] 7.1 在 `detectSyncChanges` 中添加时间线差异对比逻辑
    - 检查 `diffByTimeline` 配置
    - 如果为 true，调用 `AssetService.refreshAssetsByDiffTimeline`
    - 如果为 false，调用 `AssetService.refreshAssetsFull`
    - 在调用前创建 `CrontabHistory` 并获取历史时间线快照
    - _需求：5.1, 5.2, 5.3, 5.4_

  - [x] 7.2 确保时间线快照在同步完成后保存
    - 在 `executeSync` 结束时保存时间线快照到 `CrontabHistory`
    - _需求：5.6_

  - [x] 7.3 处理空历史快照的情况
    - 如果没有历史快照，使用空 Map 作为基准
    - _需求：5.7_

  - [ ]* 7.4 为时间线差异识别编写属性测试
    - **属性 12：时间线差异识别**
    - **验证需求：5.4**

  - [ ]* 7.5 为时间线快照保存编写属性测试
    - **属性 13：时间线快照保存**
    - **验证需求：5.6**

  - [ ]* 7.6 为空时间线基准编写属性测试
    - **属性 14：空时间线基准**
    - **验证需求：5.7**

- [ ] 8. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

- [ ] 9. 增强错误处理和日志记录
  - [x] 9.1 添加文件类型过滤的日志记录
    - 记录被过滤的资产数量
    - _需求：7.1_

  - [x] 9.2 添加跳过已存在文件的日志记录
    - 记录跳过的文件信息
    - _需求：7.2_

  - [x] 9.3 添加路径表达式解析的错误处理
    - 捕获解析异常，记录警告日志
    - 回退到默认路径
    - _需求：7.3_

  - [x] 9.4 添加并发下载的错误处理
    - 记录详细的错误信息和堆栈跟踪
    - _需求：7.4_

  - [x] 9.5 添加时间线差异对比的日志记录
    - 记录对比结果和需要刷新的日期
    - _需求：7.5_

  - [x] 9.6 添加同步开始和结束的日志记录
    - 记录同步模式、文件数量、耗时等
    - _需求：7.6_

  - [ ]* 9.7 为同步详情记录编写属性测试
    - **属性 15：同步详情记录完整性**
    - **验证需求：7.7**

- [ ] 10. 编写集成测试
  - [ ] 10.1 编写完整同步流程的集成测试
    - 测试检测变化 → 并发处理 → 更新记录的完整流程
    - 测试与后处理的集成
    - 测试与归档功能的集成

  - [ ] 10.2 编写单元测试
    - 文件类型过滤的边缘情况
    - 跳过已存在文件的边缘情况
    - 路径表达式的边缘情况
    - 并发处理的边缘情况
    - 时间线差异对比的边缘情况

- [ ] 11. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

## 注意事项

- 标记为 `*` 的任务是可选的，可以跳过以加快 MVP 开发
- 每个任务都引用了具体的需求，确保可追溯性
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边缘情况
