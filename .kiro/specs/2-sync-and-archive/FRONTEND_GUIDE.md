# 前端使用指南 - 同步与归档功能

## 📱 功能概览

新增的"同步与归档"管理页面提供了以下功能：

1. **云端空间监控** - 实时查看小米云空间使用情况
2. **云端同步** - 检测并同步云端与本地的照片差异
3. **智能归档** - 根据时间或空间阈值自动归档照片

## 🚀 快速开始

### 1. 启动前端开发服务器

```bash
cd XiaomiAlbumSyncer/web
yarn install  # 首次运行需要安装依赖
yarn dev
```

访问 `http://localhost:5173` 打开应用。

### 2. 登录系统

使用 Passkey 或密码登录系统。

### 3. 访问同步与归档页面

点击顶部导航栏的"同步与归档"标签，或直接访问：
```
http://localhost:5173/#/dashboard/sync-archive
```

## 📊 功能详解

### 云端空间卡片

**功能**：
- 显示云端空间使用率（百分比和进度条）
- 显示总容量、已使用、相册占用、剩余空间
- 空间不足警告（使用率 ≥ 90% 显示红色警告，≥ 75% 显示黄色提示）

**操作**：
- 点击"刷新"按钮重新加载空间信息

**颜色说明**：
- 🟢 绿色（< 75%）：空间充足
- 🟡 黄色（75% - 89%）：建议关注
- 🔴 红色（≥ 90%）：空间不足，建议归档

### 同步状态卡片

**功能**：
- 显示当前同步运行状态（运行中/空闲）
- 显示上次同步时间和结果（成功/失败）
- 检测云端与本地的差异
- 执行同步操作

**操作流程**：
1. 点击"检测变化"按钮
2. 查看检测结果：
   - 新增照片数量（绿色）
   - 删除照片数量（红色）
   - 修改照片数量（黄色）
   - 总计变化数量（蓝色）
3. 点击"执行同步"按钮开始同步
4. 等待同步完成，查看结果

**注意事项**：
- 同步运行时无法再次执行
- 同步会自动下载新增的照片
- 同步会删除本地已删除的云端照片
- 同步会更新修改过的照片

### 归档预览卡片

**功能**：
- 预览归档计划（不执行实际操作）
- 显示待归档照片列表
- 显示预计释放的云端空间
- 执行归档操作

**操作流程**：
1. 点击"预览归档"按钮
2. 查看归档计划：
   - 归档截止日期（基于时间模式）
   - 待归档照片数量
   - 预计释放空间
   - 待归档照片列表（显示前 10 个）
3. 点击"执行归档"按钮
4. 在确认对话框中查看详情
5. 点击"确认执行"开始归档
6. 等待归档完成

**注意事项**：
- 归档会将照片从 sync 文件夹移动到 backup 文件夹
- 如果配置了删除云端，归档后会删除云端照片（不可恢复）
- 归档操作会进行 SHA1 完整性验证
- 如果归档失败，会自动回滚已移动的文件

## ⚙️ 配置说明

在执行同步和归档之前，需要在定时任务配置中启用相关功能：

### 同步配置

在 CrontabConfig 中添加：
```kotlin
enableSync = true
syncFolder = "sync"  // 同步文件夹路径
```

### 归档配置（基于时间）

```kotlin
enableArchive = true
archiveMode = ArchiveMode.TIME
archiveDays = 30  // 保留最近 30 天的照片
backupFolder = "backup"  // 归档文件夹路径
deleteCloudAfterArchive = true  // 归档后删除云端照片
confirmBeforeArchive = true  // 执行前需要确认
```

### 归档配置（基于空间阈值）

```kotlin
enableArchive = true
archiveMode = ArchiveMode.SPACE
cloudSpaceThreshold = 90  // 保持云端使用率低于 90%
backupFolder = "backup"
deleteCloudAfterArchive = true
confirmBeforeArchive = true
```

## 🎨 界面说明

### 选择器

页面顶部有两个下拉选择器：
1. **选择账号** - 选择要管理的小米账号
2. **选择定时任务** - 选择该账号下的定时任务

选择后，所有功能卡片会自动加载对应的数据。

### 布局

- **左列**：云端空间卡片 + 同步状态卡片
- **右列**：归档预览卡片

### 响应式设计

- 桌面端：两列布局
- 平板/手机：单列布局，卡片垂直排列

## 🔔 提示和警告

### 成功提示（绿色）
- 同步已启动
- 归档已启动

### 错误提示（红色）
- 同步失败
- 归档失败
- API 调用失败

### 警告提示（黄色）
- 空间使用率 ≥ 75%
- 归档确认对话框

## 🐛 故障排除

### 无法加载数据

**可能原因**：
1. 后端服务器未启动
2. 账号或定时任务未选择
3. 网络连接问题

**解决方法**：
1. 确保后端服务器运行在 `http://localhost:8080`
2. 检查浏览器控制台的错误信息
3. 尝试刷新页面

### 同步/归档执行失败

**可能原因**：
1. 定时任务配置未启用相关功能
2. 文件系统权限不足
3. 磁盘空间不足
4. 网络连接问题

**解决方法**：
1. 检查定时任务配置
2. 检查文件夹权限
3. 检查磁盘空间
4. 查看后端日志获取详细错误信息

### TypeScript 类型错误

**可能原因**：
API 类型定义与后端不匹配

**解决方法**：
1. 启动后端服务器
2. 运行 `yarn api` 重新生成类型定义
3. 重启前端开发服务器

## 📝 开发说明

### 组件文件

- `SyncStatusCard.vue` - 同步状态卡片
- `ArchivePreviewCard.vue` - 归档预览卡片
- `CloudSpaceCard.vue` - 云端空间卡片
- `DashboardSyncArchivePage.vue` - 管理页面

### API 服务

- `SyncController.ts` - 同步 API
- `ArchiveController.ts` - 归档 API
- `CloudController.ts` - 云端空间 API

### 路由

- 路径：`/dashboard/sync-archive`
- 名称：`dashboard-sync-archive`
- 组件：`DashboardSyncArchivePage.vue`

## 🎯 最佳实践

1. **定期检查云端空间**：建议每周查看一次云端空间使用情况
2. **及时同步**：发现云端有新照片时及时同步到本地
3. **定期归档**：当空间使用率超过 75% 时考虑执行归档
4. **备份重要照片**：归档前确保重要照片已备份
5. **测试归档计划**：执行归档前先使用"预览归档"功能查看计划

## 📞 技术支持

如有问题，请：
1. 查看浏览器控制台的错误信息
2. 查看后端日志
3. 提交 GitHub Issue：https://github.com/coooolfan/xiaomialbumsyncer/issues
