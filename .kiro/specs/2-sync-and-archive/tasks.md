# 任务列表：云端同步与智能归档功能

## 阶段 1：数据模型和数据库迁移

### 1.1 创建新增实体模型
- [x] 1.1.1 创建 SyncRecord 实体
- [x] 1.1.2 创建 SyncRecordDetail 实体
- [x] 1.1.3 创建 ArchiveRecord 实体
- [x] 1.1.4 创建 ArchiveDetail 实体
- [x] 1.1.5 创建枚举类型（SyncStatus、SyncOperation、ArchiveMode、ArchiveStatus）

### 1.2 扩展现有实体
- [x] 1.2.1 扩展 CrontabConfig 添加同步和归档配置字段

### 1.3 数据库迁移
- [x] 1.3.1 创建数据库迁移脚本（V0.13.0__sync_and_archive.sql）
- [x] 1.3.2 添加必要的索引优化查询性能
- [x] 1.3.3 测试数据库迁移脚本

## 阶段 2：小米云 API 集成

### 2.1 扩展 XiaoMiApi 类
- [x] 2.1.1 实现删除照片 API（deleteAsset）
- [x] 2.1.2 实现批量删除照片 API（batchDeleteAssets）
- [x] 2.1.3 实现获取云端空间使用情况 API（getCloudSpace）
- [x] 2.1.4 添加 API 错误处理和重试机制

### 2.2 单元测试
- [-] 2.2.1 测试删除照片 API
- [ ] 2.2.2 测试批量删除照片 API
- [ ] 2.2.3 测试获取云端空间 API
- [ ] 2.2.4 测试错误处理和重试机制

## 阶段 3：文件服务实现

### 3.1 创建 FileService
- [x] 3.1.1 实现文件移动功能（moveFile）
- [x] 3.1.2 实现文件复制功能（copyFile）
- [x] 3.1.3 实现文件删除功能（deleteFile）
- [x] 3.1.4 实现 SHA1 验证功能（verifySha1）
- [x] 3.1.5 实现批量文件操作功能

### 3.2 单元测试
- [ ] 3.2.1 测试文件移动功能
- [ ] 3.2.2 测试文件复制功能
- [ ] 3.2.3 测试文件删除功能
- [ ] 3.2.4 测试 SHA1 验证功能
- [ ] 3.2.5 测试错误处理（权限不足、磁盘空间不足等）

## 阶段 4：同步服务实现

### 4.1 创建 SyncService
- [x] 4.1.1 实现变化检测算法（detectChanges）
- [x] 4.1.2 实现同步执行逻辑（executeSync）
- [x] 4.1.3 实现获取同步记录功能（getSyncRecords）
- [x] 4.1.4 实现获取同步状态功能（getSyncStatus）
- [x] 4.1.5 实现同步记录和详情的数据库操作

### 4.2 单元测试
- [ ] 4.2.1 测试变化检测算法
- [ ] 4.2.2 测试同步执行逻辑
- [ ] 4.2.3 测试同步记录查询
- [ ] 4.2.4 测试同步状态查询
- [ ] 4.2.5 测试错误处理

### 4.3 属性测试
- [ ] 4.3.1 属性 1：新增照片完整下载
- [ ] 4.3.2 属性 2：删除照片同步一致性
- [ ] 4.3.3 属性 3：修改照片更新一致性
- [ ] 4.3.4 属性 4：增量同步幂等性
- [ ] 4.3.5 属性 14：同步记录详情一致性

## 阶段 5：归档服务实现

### 5.1 创建 ArchiveService
- [x] 5.1.1 实现基于时间的归档计算（calculateTimeBasedArchive）
- [x] 5.1.2 实现基于空间阈值的归档计算（calculateSpaceBasedArchive）
- [x] 5.1.3 实现归档预览功能（previewArchive）
- [x] 5.1.4 实现归档执行逻辑（executeArchive）
- [x] 5.1.5 实现文件移动到 backup 功能（moveToBackup）
- [x] 5.1.6 实现获取归档记录功能（getArchiveRecords）
- [x] 5.1.7 实现获取归档详情功能（getArchiveDetails）

### 5.2 单元测试
- [ ] 5.2.1 测试基于时间的归档计算
- [ ] 5.2.2 测试基于空间阈值的归档计算
- [ ] 5.2.3 测试归档预览功能
- [ ] 5.2.4 测试归档执行逻辑
- [ ] 5.2.5 测试文件移动功能
- [ ] 5.2.6 测试归档记录查询
- [ ] 5.2.7 测试错误处理和回滚

### 5.3 属性测试
- [ ] 5.3.1 属性 5：归档时间点计算正确性
- [ ] 5.3.2 属性 6：归档照片选择正确性
- [ ] 5.3.3 属性 7：云端删除条件性
- [ ] 5.3.4 属性 8：空间阈值归档充分性
- [ ] 5.3.5 属性 9：归档操作顺序正确性
- [ ] 5.3.6 属性 10：失败安全性
- [ ] 5.3.7 属性 11：预览准确性
- [ ] 5.3.8 属性 12：归档记录完整性
- [ ] 5.3.9 属性 13：文件移动完整性

## 阶段 6：控制器实现

### 6.1 创建 SyncController
- [x] 6.1.1 实现执行同步接口（POST /api/sync/execute/{crontabId}）
- [x] 6.1.2 实现获取同步记录接口（GET /api/sync/records/{crontabId}）
- [x] 6.1.3 实现获取同步状态接口（GET /api/sync/status/{crontabId}）
- [x] 6.1.4 实现检测变化接口（GET /api/sync/detect-changes/{crontabId}）
- [x] 6.1.5 添加权限验证和错误处理

### 6.2 创建 ArchiveController
- [x] 6.2.1 实现预览归档接口（POST /api/archive/preview/{crontabId}）
- [x] 6.2.2 实现执行归档接口（POST /api/archive/execute/{crontabId}）
- [x] 6.2.3 实现获取归档记录接口（GET /api/archive/records/{crontabId}）
- [x] 6.2.4 实现获取归档详情接口（GET /api/archive/details/{recordId}）
- [x] 6.2.5 添加权限验证和错误处理

### 6.3 扩展 CloudController
- [x] 6.3.1 实现获取云端空间接口（GET /api/cloud/space/{accountId}）
- [x] 6.3.2 添加权限验证和错误处理

### 6.4 集成测试
- [ ] 6.4.1 测试同步相关接口
- [ ] 6.4.2 测试归档相关接口
- [ ] 6.4.3 测试云端空间查询接口
- [ ] 6.4.4 测试权限验证
- [ ] 6.4.5 测试错误处理

## 阶段 7：前端实现

### 7.1 生成 TypeScript API 类型
- [x] 7.1.1 运行 API 生成脚本生成新的类型定义
- [x] 7.1.2 验证生成的类型定义

### 7.2 创建同步相关组件
- [x] 7.2.1 创建同步配置组件（SyncConfigCard.vue）
- [x] 7.2.2 创建同步状态显示组件（SyncStatusCard.vue）
- [x] 7.2.3 创建同步历史记录组件（SyncHistoryList.vue）
- [x] 7.2.4 创建同步执行对话框（SyncExecutionDialog.vue）

### 7.3 创建归档相关组件
- [x] 7.3.1 创建归档配置组件（ArchiveConfigCard.vue）
- [x] 7.3.2 创建归档预览对话框（ArchivePreviewDialog.vue）
- [x] 7.3.3 创建归档历史记录组件（ArchiveHistoryList.vue）
- [x] 7.3.4 创建归档详情对话框（ArchiveDetailDialog.vue）

### 7.4 创建云端空间组件
- [x] 7.4.1 创建云端空间使用情况卡片（CloudSpaceCard.vue）
- [x] 7.4.2 创建空间使用图表组件（SpaceUsageChart.vue）

### 7.5 集成到现有页面
- [x] 7.5.1 在 CrontabCard 中添加同步和归档按钮
- [x] 7.5.2 在 DashboardSettingPage 中添加同步和归档配置
- [x] 7.5.3 创建同步和归档管理页面（可选）

### 7.6 前端测试
- [x] 7.6.1 测试同步功能 UI 交互
- [x] 7.6.2 测试归档功能 UI 交互
- [x] 7.6.3 测试云端空间显示
- [x] 7.6.4 测试错误提示和加载状态

## 阶段 8：集成和端到端测试

### 8.1 完整流程测试
- [ ] 8.1.1 测试完整同步流程（新增、删除、修改）
- [ ] 8.1.2 测试完整归档流程（基于时间）
- [ ] 8.1.3 测试完整归档流程（基于空间阈值）
- [ ] 8.1.4 测试同步 + 归档组合流程

### 8.2 错误场景测试
- [ ] 8.2.1 测试网络错误恢复
- [ ] 8.2.2 测试文件系统错误处理
- [ ] 8.2.3 测试 API 错误处理
- [ ] 8.2.4 测试并发操作

### 8.3 性能测试
- [ ] 8.3.1 测试大量文件同步性能（10000+ 文件）
- [ ] 8.3.2 测试大量文件归档性能（10000+ 文件）
- [ ] 8.3.3 测试并发同步性能
- [ ] 8.3.4 测试数据库查询性能

### 8.4 用户验收测试
- [ ] 8.4.1 邀请用户测试同步功能
- [ ] 8.4.2 邀请用户测试归档功能
- [ ] 8.4.3 收集用户反馈
- [ ] 8.4.4 修复用户报告的问题

## 阶段 9：文档和发布

### 9.1 更新文档
- [ ] 9.1.1 更新 README.md 添加同步和归档功能说明
- [ ] 9.1.2 创建同步功能使用指南
- [ ] 9.1.3 创建归档功能使用指南
- [ ] 9.1.4 更新 API 文档

### 9.2 发布准备
- [ ] 9.2.1 更新版本号
- [ ] 9.2.2 编写 CHANGELOG
- [ ] 9.2.3 创建发布说明
- [ ] 9.2.4 准备演示视频或截图

### 9.3 发布
- [ ] 9.3.1 合并代码到主分支
- [ ] 9.3.2 创建 Git 标签
- [ ] 9.3.3 构建 Docker 镜像
- [ ] 9.3.4 发布到 GitHub Release

## 阶段 10：监控和优化（可选）

### 10.1 监控
- [ ]* 10.1.1 添加同步操作监控指标
- [ ]* 10.1.2 添加归档操作监控指标
- [ ]* 10.1.3 添加性能监控
- [ ]* 10.1.4 添加错误监控和告警

### 10.2 优化
- [ ]* 10.2.1 优化同步算法性能
- [ ]* 10.2.2 优化归档算法性能
- [ ]* 10.2.3 优化数据库查询
- [ ]* 10.2.4 优化文件操作

### 10.3 后续迭代
- [ ]* 10.3.1 支持双向同步（本地 → 云端）
- [ ]* 10.3.2 支持多种归档策略（按相册、按文件类型）
- [ ]* 10.3.3 支持归档到其他云存储
- [ ]* 10.3.4 支持照片去重和压缩

---

## 任务优先级说明

- 无标记：必须实现（P0）
- `*`：可选实现（P2）

## 预估工作量

- 阶段 1-2：2-3 天
- 阶段 3-5：5-7 天
- 阶段 6：2-3 天
- 阶段 7：3-4 天
- 阶段 8：2-3 天
- 阶段 9：1-2 天
- 阶段 10：按需安排

**总计：约 15-22 天**

## 依赖关系

- 阶段 2 依赖阶段 1
- 阶段 4 依赖阶段 2、3
- 阶段 5 依赖阶段 2、3、4
- 阶段 6 依赖阶段 4、5
- 阶段 7 依赖阶段 6
- 阶段 8 依赖阶段 7
- 阶段 9 依赖阶段 8
