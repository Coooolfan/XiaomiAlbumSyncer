# Spec 2: 云端同步与智能归档功能

## 1. 项目背景

### 1.1 问题描述
- 小米云空间有限，需要对旧照片进行归档释放云端空间
- 用户会在云端筛选删除废片，需要同步删除操作到本地
- 当前项目只支持单向备份（云端→本地），不支持删除同步和智能归档

### 1.2 目标用户
- 小米云相册的重度使用者
- 云空间接近满载的用户
- 需要长期保存照片但不想付费扩容的用户

## 2. 功能需求

### 2.1 核心功能概述

实现一个智能的照片管理系统，包含两个核心功能：
1. **同步功能**：云端到本地的完整同步（新增、删除、修改）
2. **归档功能**：基于时间或空间阈值自动归档旧照片并释放云空间

### 2.2 文件夹结构设计

```
下载根目录/
├── sync/          # 同步文件夹（与云端保持一致的镜像）
│   └── {相册名}/
│       └── {照片文件}
└── backup/        # 归档文件夹（长期保存，不再同步）
    └── {相册名}/
        └── {照片文件}
```

**说明**：
- `sync` 文件夹：动态变化，始终反映云端当前状态
- `backup` 文件夹：只增不减，永久保存已归档的照片

### 2.3 用户故事

#### 故事 1：云端同步到本地
**作为** 小米云相册用户  
**我想要** 将云端的照片完整同步到本地 sync 文件夹  
**以便** 本地文件夹始终与云端保持一致

**验收标准**：
- 云端新增照片时，自动下载到 sync 文件夹
- 云端删除照片时，自动从 sync 文件夹删除对应文件
- 云端修改照片时，自动更新 sync 文件夹中的文件
- 同步过程记录详细日志
- 支持增量同步，避免重复下载

#### 故事 2：基于天数的智能归档
**作为** 用户  
**我想要** 设置保留最近 N 天的照片在云端  
**以便** 自动归档旧照片并释放云空间

**验收标准**：
- 可以配置保留天数（如 30 天、90 天、180 天）
- 自动计算归档时间点（今天 - N 天）
- 将 sync 文件夹中超过 N 天的照片移动到 backup 文件夹
- 在云端删除已归档的照片
- 提供归档前的确认机制
- 归档操作记录详细日志

#### 故事 3：基于空间阈值的智能归档
**作为** 用户  
**我想要** 设置云空间使用阈值（如 90%）  
**以便** 自动归档足够的旧照片使云空间使用率低于阈值

**验收标准**：
- 可以配置云空间使用阈值（百分比）
- 自动获取小米云总空间和已用空间
- 计算需要归档多少天的照片才能满足阈值
- 将 sync 文件夹中对应时间段的照片移动到 backup 文件夹
- 在云端删除已归档的照片
- 提供归档前的确认机制
- 归档操作记录详细日志

#### 故事 4：安全的归档流程
**作为** 用户  
**我想要** 确保照片在本地安全保存后才删除云端  
**以便** 避免数据丢失

**验收标准**：
- 归档流程：先移动到 backup → 验证文件完整性 → 删除云端
- 如果移动或验证失败，不删除云端照片
- 提供归档前的预览功能（显示将要归档的照片列表）
- 支持手动确认或自动执行
- 归档失败时提供详细的错误信息

#### 故事 5：归档历史记录
**作为** 用户  
**我想要** 查看归档历史记录  
**以便** 了解哪些照片被归档了，何时归档的

**验收标准**：
- 记录每次归档操作的详细信息
- 包含：归档时间、归档照片数量、释放的云空间大小
- 支持按时间查询归档记录
- 支持查看具体归档了哪些照片

#### 故事 6：配置管理
**作为** 用户  
**我想要** 灵活配置同步和归档策略  
**以便** 根据自己的需求调整行为

**验收标准**：
- 支持启用/禁用同步功能
- 支持启用/禁用归档功能
- 支持选择归档模式（基于天数 / 基于空间阈值）
- 支持配置归档后是否删除云端
- 支持配置是否需要手动确认
- 配置变更立即生效

## 3. 非功能需求

### 3.1 性能要求
- 同步操作支持并发处理，提升效率
- 大量文件归档时不阻塞其他操作
- 数据库查询优化，避免全表扫描

### 3.2 可靠性要求
- 网络异常时自动重试
- 文件操作失败时回滚
- 关键操作提供事务保证

### 3.3 可用性要求
- 提供友好的 Web UI 界面
- 操作进度实时显示
- 错误信息清晰易懂

### 3.4 安全性要求
- 删除云端照片前必须确认本地已保存
- 提供归档前的确认机制
- 敏感操作记录审计日志

### 3.5 可维护性要求
- 代码结构清晰，易于扩展
- 关键逻辑添加详细注释
- 提供完整的开发文档

## 4. 技术约束

### 4.1 技术栈
- 后端：Kotlin + Solon + Jimmer ORM + SQLite
- 前端：Vue 3 + TypeScript + PrimeVue
- API：小米云 API（需要调研删除照片的 API）

### 4.2 兼容性
- 需要与现有的备份功能兼容
- 数据库需要平滑迁移
- 配置文件向后兼容

### 4.3 依赖关系
- 依赖小米云 API 提供删除照片接口
- 依赖小米云 API 提供空间使用情况接口
- 依赖现有的下载和数据库模块

## 5. 数据模型设计

### 5.1 新增实体

#### SyncRecord（同步记录）
```kotlin
@Entity
interface SyncRecord {
    @Id
    val id: Long
    
    @ManyToOne
    val crontab: Crontab  // 关联的定时任务
    
    val syncTime: Instant  // 同步时间
    
    val addedCount: Int    // 新增文件数
    val deletedCount: Int  // 删除文件数
    val updatedCount: Int  // 更新文件数
    
    val isCompleted: Boolean  // 是否完成
    val errorMessage: String?  // 错误信息
}
```

#### ArchiveRecord（归档记录）
```kotlin
@Entity
interface ArchiveRecord {
    @Id
    val id: Long
    
    @ManyToOne
    val crontab: Crontab  // 关联的定时任务
    
    val archiveTime: Instant  // 归档时间
    val archiveMode: ArchiveMode  // 归档模式（TIME / SPACE）
    
    val archiveBeforeDate: LocalDate  // 归档此日期之前的照片
    val archivedCount: Int  // 归档文件数
    val freedSpaceBytes: Long  // 释放的云空间（字节）
    
    val isCompleted: Boolean  // 是否完成
    val errorMessage: String?  // 错误信息
}
```

#### ArchiveDetail（归档详情）
```kotlin
@Entity
interface ArchiveDetail {
    @Id
    val id: Long
    
    @ManyToOne
    val archiveRecord: ArchiveRecord  // 关联的归档记录
    
    @ManyToOne
    val asset: Asset  // 关联的资产
    
    val sourcePath: String  // 原路径（sync）
    val targetPath: String  // 目标路径（backup）
    
    val isMovedToBackup: Boolean  // 是否已移动到 backup
    val isDeletedFromCloud: Boolean  // 是否已从云端删除
}
```

### 5.2 扩展现有实体

#### CrontabConfig（扩展配置）
```kotlin
data class CrontabConfig(
    // ... 现有配置 ...
    
    // 同步配置
    val enableSync: Boolean = false,  // 是否启用同步
    val syncFolder: String = "./sync",  // 同步文件夹路径
    
    // 归档配置
    val enableArchive: Boolean = false,  // 是否启用归档
    val archiveMode: ArchiveMode = ArchiveMode.TIME,  // 归档模式
    val archiveDays: Int = 30,  // 保留天数（时间模式）
    val cloudSpaceThreshold: Int = 90,  // 云空间阈值百分比（空间模式）
    val backupFolder: String = "./backup",  // 归档文件夹路径
    val deleteCloudAfterArchive: Boolean = true,  // 归档后是否删除云端
    val confirmBeforeArchive: Boolean = true,  // 归档前是否需要确认
)

enum class ArchiveMode {
    TIME,   // 基于时间
    SPACE   // 基于空间阈值
}
```

## 6. API 设计

### 6.1 小米云 API 调研需求

需要调研以下 API：
1. **删除照片 API**
   - 接口路径
   - 请求参数（照片 ID、相册 ID 等）
   - 响应格式
   - 是否支持批量删除

2. **获取空间使用情况 API**
   - 接口路径
   - 响应格式（总空间、已用空间）
   - 是否包含相册空间占用详情

3. **修改照片 API**（如果支持）
   - 接口路径
   - 支持的修改操作

### 6.2 后端 API 设计

#### 同步相关
- `POST /api/sync/execute/{crontabId}` - 执行同步任务
- `GET /api/sync/records/{crontabId}` - 获取同步记录
- `GET /api/sync/status/{crontabId}` - 获取同步状态

#### 归档相关
- `POST /api/archive/preview/{crontabId}` - 预览归档计划
- `POST /api/archive/execute/{crontabId}` - 执行归档任务
- `GET /api/archive/records/{crontabId}` - 获取归档记录
- `GET /api/archive/details/{recordId}` - 获取归档详情

#### 空间查询
- `GET /api/cloud/space/{accountId}` - 获取云空间使用情况

## 7. 实现优先级

### P0（必须实现）
1. 同步功能：云端新增 → 本地下载
2. 同步功能：云端删除 → 本地删除
3. 归档功能：基于天数归档
4. 归档功能：移动文件到 backup
5. 数据库模型和迁移脚本

### P1（重要）
1. 归档功能：删除云端照片
2. 归档功能：基于空间阈值归档
3. 同步和归档记录查询
4. Web UI 界面

### P2（可选）
1. 同步功能：云端修改 → 本地更新
2. 归档前预览功能
3. 归档历史详情查询
4. 批量操作优化

## 8. 风险与挑战

### 8.1 技术风险
- **小米云 API 限制**：可能没有公开的删除照片 API
  - 缓解措施：调研逆向工程或使用 Web 端 API
  
- **大量文件操作性能**：归档大量照片可能耗时较长
  - 缓解措施：使用异步处理、批量操作、进度显示

- **数据一致性**：同步和归档过程中可能出现不一致
  - 缓解措施：使用事务、状态机、重试机制

### 8.2 业务风险
- **误删风险**：归档后删除云端可能导致数据丢失
  - 缓解措施：强制确认、备份验证、可恢复机制

- **空间计算不准确**：云空间使用情况可能不实时
  - 缓解措施：添加安全边际、定期刷新

### 8.3 用户体验风险
- **操作复杂**：配置项过多可能让用户困惑
  - 缓解措施：提供预设模板、智能推荐、详细说明

## 9. 测试计划

### 9.1 单元测试
- 同步逻辑测试
- 归档逻辑测试
- 空间计算测试
- 文件操作测试

### 9.2 集成测试
- 完整同步流程测试
- 完整归档流程测试
- 异常场景测试

### 9.3 端到端测试
- 用户操作流程测试
- 多账号场景测试
- 大数据量测试

## 10. 发布计划

### 10.1 Alpha 版本
- 实现 P0 功能
- 内部测试

### 10.2 Beta 版本
- 实现 P1 功能
- 小范围用户测试

### 10.3 正式版本
- 实现 P2 功能
- 完善文档
- 公开发布

## 11. 后续迭代方向

1. 支持双向同步（本地 → 云端）
2. 支持多种归档策略（按相册、按文件类型）
3. 支持归档到其他云存储（阿里云 OSS、腾讯云 COS）
4. 支持照片去重和压缩
5. 支持智能相册分类
